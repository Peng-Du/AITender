# 简化版标书下载系统设计文档
**适用场景：10人办公室单机部署**
**工作目录：D:\AITender\TenderServer**

## 1. 系统概述

这是一个极简版本的标书下载系统，专为小型办公室设计，满足10人左右的内部使用需求。

### 1.1 核心功能
- 🔍 **简单搜索**: 按标题和描述搜索标书
- 📋 **结果列表**: 显示搜索结果和下载链接
- ⬇️ **文件下载**: 直接点击下载标书文件
- 👥 **基础用户**: 简单的用户登录和管理

### 1.2 设计原则
- **极简架构**: 单机部署，最少组件
- **易于维护**: 技术栈简单，学习成本低
- **快速部署**: 一键安装，开箱即用
- **成本最低**: 使用开源免费软件

## 2. 系统架构

```
┌─────────────────────────────────────────┐
│              用户浏览器                  │
│         (Chrome/Firefox/Edge)          │
└─────────────────┬───────────────────────┘
                  │ HTTP/HTTPS
                  ▼
┌─────────────────────────────────────────┐
│           Web服务器 (单机)              │
│  ┌─────────────────────────────────────┐ │
│  │      前端应用 (静态文件)            │ │
│  │    HTML/CSS/JavaScript              │ │
│  └─────────────────────────────────────┘ │
│  ┌─────────────────────────────────────┐ │
│  │      后端服务                        │ │
│  │    Node.js + Express                │ │
│  └─────────────────────────────────────┘ │
│  ┌─────────────────────────────────────┐ │
│  │      数据库                          │ │
│  │    SQLite (单文件)                  │ │
│  └─────────────────────────────────────┘ │
│  ┌─────────────────────────────────────┐ │
│  │      文件存储                        │ │
│  │    本地文件夹                       │ │
│  └─────────────────────────────────────┘ │
└─────────────────────────────────────────┘
```

## 3. 技术栈选择

### 3.1 前端技术栈
- **基础**: HTML5 + CSS3 + JavaScript (ES6)
- **UI框架**: Bootstrap 5 (简单易用)
- **搜索功能**: 原生JavaScript实现
- **文件上传**: 原生FormData API
- **无需构建工具**: 直接在浏览器运行

### 3.2 后端技术栈
- **运行时**: Node.js 18+ (LTS版本)
- **框架**: Express.js (最简单的Web框架)
- **数据库**: SQLite (无需安装，单文件数据库)
- **文件存储**: 本地文件系统
- **认证**: 简单的Session认证

### 3.3 开发工具
- **代码编辑**: VSCode (免费)
- **版本控制**: Git (免费)
- **API测试**: Postman (免费版)

## 4. 数据库设计 (SQLite)

### 4.1 数据库结构
```sql
-- 用户表
CREATE TABLE users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username TEXT UNIQUE NOT NULL,
    password_hash TEXT NOT NULL,
    full_name TEXT NOT NULL,
    role TEXT DEFAULT 'user',  -- 'user' 或 'admin'
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 标书表
CREATE TABLE tenders (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    title TEXT NOT NULL,
    description TEXT,
    file_path TEXT NOT NULL,  -- 相对路径
    file_name TEXT NOT NULL,
    file_size INTEGER NOT NULL,
    upload_user_id INTEGER,
    download_count INTEGER DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (upload_user_id) REFERENCES users(id)
);

-- 下载记录表 (可选，用于统计)
CREATE TABLE download_records (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    tender_id INTEGER NOT NULL,
    user_id INTEGER NOT NULL,
    download_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    ip_address TEXT,
    FOREIGN KEY (tender_id) REFERENCES tenders(id),
    FOREIGN KEY (user_id) REFERENCES users(id)
);
```

### 4.2 索引优化
```sql
-- 为搜索创建索引
CREATE INDEX idx_tenders_title ON tenders(title);
CREATE INDEX idx_tenders_description ON tenders(description);
CREATE INDEX idx_tenders_created_at ON tenders(created_at);
```

## 5. 项目结构

```
D:\AITender\TenderServer\
├── package.json              # Node.js项目配置
├── server.js                 # 后端入口文件
├── config/
│   ├── database.js           # 数据库配置
│   └── config.js             # 应用配置
├── routes/
│   ├── auth.js               # 认证路由
│   ├── tenders.js            # 标书相关路由
│   └── upload.js             # 文件上传路由
├── middleware/
│   ├── auth.js               # 认证中间件
│   └── upload.js             # 文件上传中间件
├── models/
│   ├── User.js               # 用户模型
│   └── Tender.js             # 标书模型
├── public/                   # 前端静态文件
│   ├── index.html            # 首页
│   ├── login.html            # 登录页
│   ├── css/
│   │   └── style.css         # 样式文件
│   ├── js/
│   │   ├── app.js            # 主应用逻辑
│   │   ├── auth.js           # 认证逻辑
│   │   └── search.js         # 搜索逻辑
│   └── assets/               # 静态资源
├── uploads/                  # 上传文件存储目录
├── database/
│   └── tender.db             # SQLite数据库文件
└── README.md                 # 项目说明
```

## 6. 核心功能实现

### 6.1 后端核心代码 (server.js)
```javascript
const express = require('express');
const sqlite3 = require('sqlite3').verbose();
const session = require('express-session');
const path = require('path');
const multer = require('multer');

const app = express();
const PORT = 3000;

// 数据库连接 (使用绝对路径)
const dbPath = path.join(__dirname, 'database', 'tender.db');
const db = new sqlite3.Database(dbPath);

// 中间件配置
app.use(express.json());
app.use(express.urlencoded({ extended: true }));
app.use(express.static('public'));
app.use(session({
    secret: 'your-secret-key',
    resave: false,
    saveUninitialized: false,
    cookie: { maxAge: 24 * 60 * 60 * 1000 } // 24小时
}));

// 文件上传配置
const storage = multer.diskStorage({
    destination: path.join(__dirname, 'uploads'),
    filename: function(req, file, cb) {
        cb(null, Date.now() + '-' + file.originalname);
    }
});
const upload = multer({
    storage: storage,
    fileFilter: function(req, file, cb) {
        const allowedTypes = ['.pdf', '.doc', '.docx', '.zip'];
        const ext = path.extname(file.originalname).toLowerCase();
        if (allowedTypes.includes(ext)) {
            cb(null, true);
        } else {
            cb(new Error('只允许PDF、DOC、DOCX、ZIP文件'));
        }
    },
    limits: { fileSize: 50 * 1024 * 1024 } // 50MB限制
});

// 搜索接口
app.get('/api/tenders/search', (req, res) => {
    const query = req.query.q || '';
    const sql = `
        SELECT t.*, u.full_name as uploader_name
        FROM tenders t
        LEFT JOIN users u ON t.upload_user_id = u.id
        WHERE t.title LIKE ? OR t.description LIKE ?
        ORDER BY t.created_at DESC
    `;

    db.all(sql, [`%${query}%`, `%${query}%`], (err, rows) => {
        if (err) {
            return res.status(500).json({ error: err.message });
        }
        res.json(rows);
    });
});

// 下载接口
app.get('/api/tenders/:id/download', (req, res) => {
    const tenderId = req.params.id;
    const sql = 'SELECT * FROM tenders WHERE id = ?';

    db.get(sql, [tenderId], (err, tender) => {
        if (err) {
            return res.status(500).json({ error: err.message });
        }
        if (!tender) {
            return res.status(404).json({ error: '标书不存在' });
        }

        const filePath = path.join(__dirname, 'uploads', tender.file_name);
        res.download(filePath, tender.file_name, (err) => {
            if (!err) {
                // 更新下载次数
                db.run('UPDATE tenders SET download_count = download_count + 1 WHERE id = ?', [tenderId]);

                // 记录下载日志
                if (req.session.user) {
                    db.run('INSERT INTO download_records (tender_id, user_id, ip_address) VALUES (?, ?, ?)',
                        [tenderId, req.session.user.id, req.ip]);
                }
            }
        });
    });
});

// 启动服务器
app.listen(PORT, () => {
    console.log(`标书系统运行在 http://localhost:${PORT}`);
    console.log(`工作目录: ${__dirname}`);
});
```

### 6.2 前端搜索功能 (public/js/search.js)
```javascript
class TenderSearch {
    constructor() {
        this.searchInput = document.getElementById('searchInput');
        this.resultsContainer = document.getElementById('resultsContainer');
        this.searchButton = document.getElementById('searchButton');

        this.initEventListeners();
    }

    initEventListeners() {
        this.searchButton.addEventListener('click', () => this.search());
        this.searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') this.search();
        });
    }

    async search() {
        const query = this.searchInput.value.trim();
        if (!query) {
            this.showMessage('请输入搜索关键词');
            return;
        }

        try {
            const response = await fetch(`/api/tenders/search?q=${encodeURIComponent(query)}`);
            const tenders = await response.json();

            this.displayResults(tenders);
        } catch (error) {
            this.showMessage('搜索失败，请重试');
        }
    }

    displayResults(tenders) {
        if (tenders.length === 0) {
            this.resultsContainer.innerHTML = '<p>未找到相关标书</p>';
            return;
        }

        const html = tenders.map(tender => `
            <div class="tender-item">
                <h3>${this.escapeHtml(tender.title)}</h3>
                <p class="description">${this.escapeHtml(tender.description || '暂无描述')}</p>
                <div class="meta">
                    <span>上传者: ${this.escapeHtml(tender.uploader_name || '未知')}</span>
                    <span>文件大小: ${this.formatFileSize(tender.file_size)}</span>
                    <span>下载次数: ${tender.download_count}</span>
                </div>
                <div class="actions">
                    <a href="/api/tenders/${tender.id}/download" class="btn btn-primary">下载</a>
                </div>
            </div>
        `).join('');

        this.resultsContainer.innerHTML = html;
    }

    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    showMessage(message) {
        this.resultsContainer.innerHTML = `<p class="message">${message}</p>`;
    }
}

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', () => {
    new TenderSearch();
});
```

## 7. 部署方案

### 7.1 系统要求
- **操作系统**: Windows 10/11, Ubuntu 20.04+, macOS 10.15+
- **内存**: 最小4GB，推荐8GB
- **存储**: 最小50GB可用空间
- **网络**: 局域网连接

### 7.2 安装步骤

#### 步骤1: 安装Node.js
```bash
# Windows: 下载并安装 node-v18.x.x.msi
# Ubuntu:
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs
# macOS:
brew install node
```

#### 步骤2: 项目初始化
```bash
# 切换到工作目录
cd "D:\AITender\TenderServer"

# 初始化npm项目
npm init -y

# 安装依赖
npm install express sqlite3 express-session multer bcrypt

# 创建必要的目录
mkdir -p database uploads public/css public/js
```

#### 步骤3: 初始化数据库
```javascript
// scripts/init-db.js
const sqlite3 = require('sqlite3').verbose();
const path = require('path');

const dbPath = path.join(__dirname, '..', 'database', 'tender.db');
const db = new sqlite3.Database(dbPath);

// 创建表
db.serialize(() => {
    // 用户表
    db.run(`CREATE TABLE IF NOT EXISTS users (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        username TEXT UNIQUE NOT NULL,
        password_hash TEXT NOT NULL,
        full_name TEXT NOT NULL,
        role TEXT DEFAULT 'user',
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP
    )`);

    // 标书表
    db.run(`CREATE TABLE IF NOT EXISTS tenders (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        title TEXT NOT NULL,
        description TEXT,
        file_path TEXT NOT NULL,
        file_name TEXT NOT NULL,
        file_size INTEGER NOT NULL,
        upload_user_id INTEGER,
        download_count INTEGER DEFAULT 0,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (upload_user_id) REFERENCES users(id)
    )`);

    // 下载记录表
    db.run(`CREATE TABLE IF NOT EXISTS download_records (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        tender_id INTEGER NOT NULL,
        user_id INTEGER NOT NULL,
        download_time DATETIME DEFAULT CURRENT_TIMESTAMP,
        ip_address TEXT,
        FOREIGN KEY (tender_id) REFERENCES tenders(id),
        FOREIGN KEY (user_id) REFERENCES users(id)
    )`);

    // 创建索引
    db.run('CREATE INDEX IF NOT EXISTS idx_tenders_title ON tenders(title)');
    db.run('CREATE INDEX IF NOT EXISTS idx_tenders_description ON tenders(description)');
    db.run('CREATE INDEX IF NOT EXISTS idx_tenders_created_at ON tenders(created_at)');

    console.log('数据库初始化完成');
});

db.close();
```

#### 步骤4: 启动服务
```bash
# 初始化数据库
node scripts/init-db.js

# 开发模式
node server.js

# 或者使用npm脚本
npm start
```

#### 步骤5: 访问系统
- 本地访问: `http://localhost:3000`
- 局域网访问: `http://[服务器IP]:3000`

### 7.3 Windows环境配置

#### 创建启动脚本 (start.bat)
```batch
@echo off
cd /d "D:\AITender\TenderServer"
echo 正在启动标书下载系统...
node server.js
pause
```

#### 创建服务启动脚本 (install-service.bat)
```batch
@echo off
cd /d "D:\AITender\TenderServer"

echo 安装PM2...
npm install -g pm2

echo 启动服务...
pm2 start server.js --name "tender-system"

echo 设置开机自启...
pm2 startup
pm2 save

echo 服务安装完成！
```

### 7.4 生产环境配置

#### 使用PM2进程管理
```bash
# 安装PM2
npm install -g pm2

# 启动应用
pm2 start server.js --name "tender-system"

# 查看状态
pm2 status

# 查看日志
pm2 logs tender-system

# 重启服务
pm2 restart tender-system

# 停止服务
pm2 stop tender-system

# 设置开机自启
pm2 startup
pm2 save
```

## 8. 安全配置

### 8.1 基础安全措施
- **密码加密**: 使用bcrypt加密存储密码
- **会话管理**: 设置合理的会话超时时间
- **文件类型限制**: 只允许特定格式的文件上传
- **文件大小限制**: 防止大文件攻击
- **输入验证**: 前后端双重输入验证

### 8.2 Windows防火墙配置
```batch
# 以管理员身份运行命令提示符
netsh advfirewall firewall add rule name="TenderServer" dir=in action=allow protocol=TCP localport=3000
```

## 9. 备份方案

### 9.1 Windows备份脚本 (backup.bat)
```batch
@echo off
set BACKUP_DIR="D:\backup\TenderServer"
set DATE=%date:~0,4%%date:~5,2%%date:~8,2%_%time:~0,2%%time:~3,2%
set DATE=%DATE: =0%

echo 开始备份...
mkdir %BACKUP_DIR% 2>nul

# 备份数据库
copy "D:\AITender\TenderServer\database\tender.db" "%BACKUP_DIR%\tender_%DATE%.db"

# 备份上传文件
powershell "Compress-Archive -Path 'D:\AITender\TenderServer\uploads\*' -DestinationPath '%BACKUP_DIR%\uploads_%DATE%.zip'"

echo 备份完成: %BACKUP_DIR%
```

### 9.2 自动备份配置 (Windows任务计划程序)
1. 打开"任务计划程序"
2. 创建基本任务
3. 设置每天凌晨2点运行
4. 触发器: `D:\AITender\TenderServer\backup.bat`

## 10. 维护指南

### 10.1 日常维护
- **日志检查**: `pm2 logs tender-system`
- **磁盘空间**: 检查uploads和database目录大小
- **性能监控**: 观察内存和CPU使用情况
- **数据清理**: 定期清理过期的下载记录

### 10.2 故障排除
| 问题 | 可能原因 | 解决方案 |
|------|----------|----------|
| 无法访问页面 | 服务未启动 | 运行 `pm2 start tender-system` |
| 搜索无结果 | 数据库为空 | 上传标书文件 |
| 下载失败 | 文件路径错误 | 检查uploads目录权限 |
| 登录失败 | 密码错误 | 重置用户密码 |
| 数据库错误 | 文件权限问题 | 检查database目录权限 |

### 10.3 升级指南
```bash
# 1. 备份数据
backup.bat

# 2. 停止服务
pm2 stop tender-system

# 3. 更新代码
git pull origin main

# 4. 更新依赖
npm install

# 5. 重启服务
pm2 start tender-system
```

## 11. 成本分析

### 11.1 硬件成本
- **服务器**: 复用现有办公电脑 ¥0
- **存储**: 500GB硬盘空间 ¥0
- **网络**: 现有局域网 ¥0

### 11.2 软件成本
- **操作系统**: Windows/Linux (已有) ¥0
- **Node.js**: 开源免费 ¥0
- **数据库**: SQLite (内嵌) ¥0
- **开发工具**: VSCode (免费) ¥0

### 11.3 人力成本
- **开发时间**: 1-2周 (1名开发人员)
- **部署配置**: 1天
- **培训使用**: 半天

**总成本**: 基本为零 (复用现有硬件和免费软件)

## 12. 扩展建议

如果未来需要扩展，可以考虑：

### 12.1 短期扩展 (1-6个月)
- 增加用户权限管理
- 添加文件分类功能
- 实现下载统计报表
- 添加批量上传功能

### 12.2 中期扩展 (6-12个月)
- 迁移到MySQL数据库
- 添加全文搜索
- 实现文件版本控制
- 添加移动端支持

### 12.3 长期扩展 (1年以上)
- 微服务架构改造
- 云端部署
- 多租户支持
- 高级搜索功能

---

## 附录A: package.json配置文件
```json
{
  "name": "tender-server",
  "version": "1.0.0",
  "description": "简化版标书下载系统",
  "main": "server.js",
  "scripts": {
    "start": "node server.js",
    "dev": "nodemon server.js",
    "init-db": "node scripts/init-db.js",
    "backup": "backup.bat"
  },
  "dependencies": {
    "express": "^4.18.2",
    "sqlite3": "^5.1.6",
    "express-session": "^1.17.3",
    "multer": "^1.4.5-lts.1",
    "bcrypt": "^5.1.1"
  },
  "devDependencies": {
    "nodemon": "^3.0.1"
  },
  "keywords": ["tender", "download", "nodejs"],
  "author": "Your Name",
  "license": "MIT"
}
```

## 附录B: 环境变量配置 (.env)
```
# 服务器配置
PORT=3000
HOST=0.0.0.0

# 数据库配置
DB_PATH=./database/tender.db

# 会话配置
SESSION_SECRET=your-secret-key-change-this-in-production
SESSION_MAX_AGE=86400000

# 文件上传配置
UPLOAD_DIR=./uploads
MAX_FILE_SIZE=52428800
ALLOWED_FILE_TYPES=.pdf,.doc,.docx,.zip
```

**总结**: 这个简化版方案以最低的成本和复杂度，满足10人办公室的标书下载需求，技术栈简单，部署维护容易，是小型团队的理想选择。项目配置为在D:\AITender\TenderServer目录下运行。